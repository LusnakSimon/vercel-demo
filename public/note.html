<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Note Editor - Research Notebook</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <header class="site-header">
      <div class="brand">
        <div class="logo">RN</div>
        <div>
          <h1>Note Editor</h1>
          <p class="lead">Write and preview markdown notes</p>
        </div>
      </div>
      <nav class="nav">
        <a href="/">Home</a>
        <a href="/todos.html">Todos</a>
        <a href="/dashboard.html">Dashboard</a>
        <span id="auth-actions"></span>
      </nav>
    </header>

    <div class="card">
      <div class="note-meta">
        <input id="note-title-input" class="note-title-input" placeholder="Note title..." />
        <div style="display:flex;gap:8px">
          <button id="save-note" class="btn btn-primary">Save Note</button>
          <button id="delete-note" class="btn btn-danger" style="display:none">Delete</button>
          <a id="cancel-link" href="/" class="btn btn-secondary">Cancel</a>
        </div>
      </div>
      
      <div id="note-meta-info" class="muted small" style="margin-bottom:16px"></div>
      
      <div class="editor-toolbar">
        <button id="tb-bold" class="btn btn-sm btn-secondary"><strong>B</strong></button>
        <button id="tb-italic" class="btn btn-sm btn-secondary"><em>I</em></button>
        <button id="tb-h1" class="btn btn-sm btn-secondary">H1</button>
        <button id="tb-code" class="btn btn-sm btn-secondary">Code</button>
        <button id="toggle-preview" class="btn btn-sm btn-secondary">Toggle Preview</button>
        <span class="editor-status" id="editor-status">Ready</span>
      </div>
      
      <div class="note-editor">
        <textarea id="note-body" placeholder="Write your markdown here..."></textarea>
        <div class="note-preview" id="note-preview"></div>
      </div>
    </div>
  </div>

  <script src="/app.js"></script>
  <script>
    function qs(name){ const u=new URL(location.href); return u.searchParams.get(name); }
    const noteId = qs('id');
    const projectId = qs('projectId');

    // autosave draft to localStorage (debounced)
    let autosaveTimeout = null;
    function draftKey() { return 'draft_note_' + (noteId || projectId || 'anon'); }
    function saveDraftToLocal(){
      const key = draftKey();
      const payload = { title: document.getElementById('note-title-input').value||'', body: document.getElementById('note-body').value||'', ts: Date.now() };
      try { localStorage.setItem(key, JSON.stringify(payload)); } catch(e){}
      if (window.showToast) showToast('Draft saved', 'success', 900);
      const status = document.getElementById('editor-status'); if(status) status.textContent = 'Draft saved';
    }

    async function init(){
      renderAuthActions();
      const bodyEl = document.getElementById('note-body');
      bodyEl.addEventListener('input', ()=>{
        const v = bodyEl.value;
        document.getElementById('note-preview').innerHTML = window.marked ? window.marked.parse(v) : escapeHtml(v);
        const status = document.getElementById('editor-status'); if(status) status.textContent = 'Editing...';
        clearTimeout(autosaveTimeout); autosaveTimeout = setTimeout(saveDraftToLocal, 1200);
      });
      // toolbar actions
      document.getElementById('tb-bold').addEventListener('click', ()=> wrapSelection(bodyEl, '**'));
      document.getElementById('tb-italic').addEventListener('click', ()=> wrapSelection(bodyEl, '*'));
      document.getElementById('tb-h1').addEventListener('click', ()=> prependLine(bodyEl, '# '));
      document.getElementById('tb-code').addEventListener('click', ()=> wrapSelection(bodyEl, '```\n', '\n```'));
      document.getElementById('toggle-preview').addEventListener('click', ()=>{ document.getElementById('note-preview').classList.toggle('hidden'); });
      document.getElementById('save-note').addEventListener('click', save);
      // restore draft if present
      const draftRaw = localStorage.getItem(draftKey());
      if (draftRaw) {
        try {
          const d = JSON.parse(draftRaw);
          if (d && (d.body || d.title)) {
            if (confirm('Restore unsaved draft from ' + new Date(d.ts).toLocaleString() + '?')) {
              document.getElementById('note-title-input').value = d.title || '';
              document.getElementById('note-body').value = d.body || '';
              document.getElementById('note-body').dispatchEvent(new Event('input'));
            }
          }
        } catch(e) { /* ignore */ }
      }
      if (noteId) await loadNote();
      if (projectId) document.getElementById('cancel-link').href = '/project-notes.html?projectId=' + encodeURIComponent(projectId);
    }

    async function loadNote(){
      try{
        const n = await api.request('/api/notes?id=' + encodeURIComponent(noteId));
        document.getElementById('note-title-input').value = n.title || '';
        document.getElementById('note-body').value = n.bodyMarkdown || '';
        document.getElementById('note-body').dispatchEvent(new Event('input'));
        // show meta
        const meta = document.getElementById('note-meta');
        meta.textContent = 'Author: ' + (n.authorId || '-') + ' · Created: ' + (n.createdAt? new Date(n.createdAt).toLocaleString() : '-') + (n.updatedAt?(' · Updated: '+new Date(n.updatedAt).toLocaleString()):'');
        // show delete button (API will enforce permission)
        const del = document.getElementById('delete-note'); if(del) { del.style.display='inline-block'; del.addEventListener('click', async ()=>{
          if(!confirm('Delete this note?')) return; try{ await api.request('/api/notes?id='+encodeURIComponent(noteId), { method:'DELETE' }); showToast('Deleted','success'); location.href = '/project-notes.html?projectId=' + encodeURIComponent(projectId || ''); }catch(e){ showToast('Delete failed: '+(e.error||JSON.stringify(e)),'error',3000); }
        }); }
      }catch(e){ if(window.showToast) showToast('Unable to load note', 'error', 2200); }
    }

    async function save(){
      const title = document.getElementById('note-title-input').value;
      const body = document.getElementById('note-body').value;
      try{
        if (noteId) {
          await api.request('/api/notes?id=' + encodeURIComponent(noteId), { method: 'PATCH', body: { title, bodyMarkdown: body } });
          if(window.showToast) showToast('Saved', 'success', 1200);
          try{ localStorage.removeItem(draftKey()); }catch(e){}
          history.back();
          return;
        }
        const payload = { title, bodyMarkdown: body };
        if (projectId) payload.projectId = projectId;
        const res = await api.request('/api/notes', { method: 'POST', body: payload });
        if(window.showToast) showToast('Created', 'success', 1200);
        try{ localStorage.removeItem(draftKey()); }catch(e){}
        location.href = '/project-notes.html?projectId=' + encodeURIComponent(res.projectId || projectId || '');
      }catch(e){ if(window.showToast) showToast('Save failed: ' + (e.error||JSON.stringify(e)), 'error', 3000); }
    }

  function wrapSelection(el, before, after){ if(typeof after==='undefined') after=before; const start=el.selectionStart, end=el.selectionEnd; const val=el.value; const selected=val.slice(start,end); el.value = val.slice(0,start)+before+selected+after+val.slice(end); el.focus(); el.selectionStart = start + before.length; el.selectionEnd = end + before.length; el.dispatchEvent(new Event('input')); }
  function prependLine(el, prefix){ const start=el.selectionStart, val=el.value; const lineStart = val.lastIndexOf('\n', start-1)+1; el.value = val.slice(0,lineStart)+prefix+val.slice(lineStart); el.focus(); el.dispatchEvent(new Event('input')); }

    // load marked.js from CDN for markdown preview if not present
    (function(){
      if (window.marked) return init();
      const s = document.createElement('script'); s.src = 'https://cdn.jsdelivr.net/npm/marked/marked.min.js'; s.onload = init; document.head.appendChild(s);
    })();
  </script>
</body>
</html>
