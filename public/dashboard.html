<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard - Research Notebook</title>
  <script>
    // Apply theme immediately to prevent flash
    (function() {
      const theme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <link rel="stylesheet" href="/styles.css">
  <script src="/enhancements.js" defer></script>
</head>
<body>
  <main class="container">
    <header class="site-header">
      <div class="brand">
        <div class="logo">RN</div>
        <div>
          <h1>Dashboard</h1>
          <p class="lead">Your research workspace</p>
        </div>
      </div>
      <nav class="nav">
        <a href="/dashboard.html">Dashboard</a>
        <a href="/projects.html">Projects</a>
        <a href="/todos.html">Todos</a>
        <a href="/notes.html">Notes</a>
        <a href="/contacts.html">Contacts</a>
        <a href="/messages.html">Messages</a>
        <button id="theme-toggle" title="Toggle theme">üåô</button>
        <button id="help-toggle" title="Keyboard shortcuts (or press ?)">‚ùì</button>
        <span id="auth-actions"></span>
      </nav>
    </header>

    <div id="dashboard-content">
      <div class="hero">
        <h2>Welcome to Your Dashboard</h2>
        <p>Please <a href="/login.html" style="color: var(--accent); text-decoration: none;">sign in</a> to view your content.</p>
      </div>
    </div>

    <div class="grid" id="dashboard-grid" style="display: none;">
      <!-- Stats Cards -->
      <div class="stats-grid" style="grid-column: 1 / -1;">
        <div class="stat-card">
          <div class="stat-value" id="stat-todos">0</div>
          <div class="stat-label">Total Todos</div>
          <div class="stat-change positive" id="stat-todos-change">+0 this week</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-completed">0</div>
          <div class="stat-label">Completed</div>
          <div class="stat-change positive" id="stat-completed-change">0% done</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-notes">0</div>
          <div class="stat-label">Notes</div>
          <div class="stat-change" id="stat-notes-change">+0 this week</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-projects">0</div>
          <div class="stat-label">Projects</div>
          <div class="stat-change" id="stat-projects-change">Active</div>
        </div>
      </div>

      <div class="card">
        <h2>üìä Recent Activity</h2>
        <div class="activity-feed" id="activity-feed">
          <div class="muted center" style="padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 12px; opacity: 0.3;">‚è∞</div>
            <div>No recent activity</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>‚úÖ Recent Todos</h2>
        <ul id="todos-list" class="todo-list"></ul>
        <a href="/todos.html" class="btn btn-secondary" style="margin-top: 16px; display: inline-block;">View All Todos</a>
      </div>

      <div class="card">
        <h2>üìù Recent Notes</h2>
        <ul id="notes-list" class="list"></ul>
        <a href="/notes.html" class="btn btn-secondary" style="margin-top: 16px; display: inline-block;">View All Notes</a>
      </div>

      <div class="card">
        <h2>üöÄ Quick Actions</h2>
        <div class="stack" style="margin-top: 20px;">
          <a href="/todos.html" class="btn btn-primary">‚ú® Create Todo</a>
          <a href="/note.html" class="btn btn-primary">üìÑ New Note</a>
          <a href="/projects.html" class="btn btn-secondary">üìÅ Manage Projects</a>
          <a href="/account.html" class="btn btn-secondary">üë§ View Profile</a>
        </div>
      </div>
    </div>

    <footer class="footer">
      <p>Research Notebook - Organize your research effectively</p>
      <div style="margin-top: 8px;">
        <a href="https://ko-fi.com/dongfeng400" target="_blank" rel="noopener" class="donate-link" title="Support this project">
          ‚òï Buy me a coffee
        </a>
      </div>
    </footer>
  </main>
  
  <script src="/app.js"></script>
  <script>
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    async function loadDashboard() {
      try {
        console.log('Checking authentication...');
        const res = await api.request('/api/auth/me');
        console.log('Auth response:', res);
        
        if (res && res.user) {
          console.log('User authenticated:', res.user.email);
          // User is authenticated
          document.getElementById('dashboard-content').style.display = 'none';
          document.getElementById('dashboard-grid').style.display = 'grid';
          
          // Load stats and data
          console.log('Loading dashboard data...');
          const [todosResponse, notesResponse, projectsResponse] = await Promise.all([
            api.request('/api/todos').catch(err => {
              console.error('Failed to load todos:', err);
              return { data: [] };
            }),
            api.request('/api/notes?limit=5').catch(err => {
              console.error('Failed to load notes:', err);
              return { data: [] };
            }),
            api.request('/api/projects').catch(err => {
              console.error('Failed to load projects:', err);
              return [];
            })
          ]);
          
          console.log('Loaded data:', { todosResponse, notesResponse, projectsResponse });
          
          // Handle paginated response format
          const todos = Array.isArray(todosResponse) ? todosResponse : (todosResponse.data || []);
          const notes = notesResponse.data || notesResponse || [];
          const projects = Array.isArray(projectsResponse) ? projectsResponse : (projectsResponse.data || []);
          
          console.log('Processed data:', { todosCount: todos.length, notesCount: notes.length, projectsCount: projects.length });
          
          // Check if new user (no projects) and show welcome banner
          if (projects.length === 0) {
            showWelcomeBanner();
          }
          
          // Update stats
          const completedCount = todos.filter(t => t.done).length;
          const completionRate = todos.length > 0 ? Math.round((completedCount / todos.length) * 100) : 0;
          
          document.getElementById('stat-todos').textContent = todos.length;
          document.getElementById('stat-completed').textContent = completedCount;
          document.getElementById('stat-completed-change').textContent = `${completionRate}% done`;
          document.getElementById('stat-notes').textContent = notes.length;
          document.getElementById('stat-projects').textContent = projects.length;
          
          // Load recent todos
          const list = document.getElementById('todos-list');
          if (todos && todos.length > 0) {
            list.innerHTML = '';
            todos.slice(0, 5).forEach(t => {
              const li = document.createElement('li');
              li.className = 'todo-item' + (t.done ? ' done' : '');
              
              const badge = t.tags && t.tags.length > 0 
                ? `<span class="badge badge-primary" style="margin-left: 8px;">${t.tags[0]}</span>` 
                : '';
              
              li.innerHTML = `
                <div class="todo-content">
                  <div class="todo-title">${escapeHtml(t.title)}${badge}</div>
                  ${t.description ? `<div class="todo-description">${escapeHtml(t.description)}</div>` : ''}
                  ${t.dueDate ? `<div class="muted small">üìÖ Due: ${new Date(t.dueDate).toLocaleDateString()}</div>` : ''}
                </div>
              `;
              li.style.cursor = 'pointer';
              li.onclick = () => window.location.href = '/todos.html';
              list.appendChild(li);
            });
          } else {
            list.innerHTML = '<li class="muted">No todos yet. <a href="/todos.html" style="color: var(--accent);">Create one</a></li>';
          }
          
          // Load recent notes
          const notesList = document.getElementById('notes-list');
          if (notes && notes.length > 0) {
            notesList.innerHTML = '';
            notes.forEach(note => {
              const li = document.createElement('li');
              li.className = 'list-item';
              li.style.cursor = 'pointer';
              li.onclick = () => window.location.href = '/note.html?id=' + encodeURIComponent(note._id);
              
              const tags = note.tags && note.tags.length > 0
                ? `<span class="badge badge-info" style="margin-left: 8px;">${note.tags[0]}</span>`
                : '';
              
              li.innerHTML = `
                <div>
                  <div style="font-weight: 600;">${escapeHtml(note.title)}${tags}</div>
                  <div class="muted small" style="margin-top: 4px;">
                    üìÖ ${new Date(note.updatedAt || note.createdAt).toLocaleDateString()}
                  </div>
                </div>
              `;
              notesList.appendChild(li);
            });
          } else {
            notesList.innerHTML = '<li class="muted">No notes yet. <a href="/note.html" style="color: var(--accent);">Create one</a></li>';
          }
          
          // Generate activity feed
          generateActivityFeed(todos, notes, projects);
        }
      } catch (err) {
        // Not authenticated, show welcome message
        console.log('Not authenticated');
      }
    }
    
    function generateActivityFeed(todos, notes, projects) {
      const feed = document.getElementById('activity-feed');
      const activities = [];
      
      // Get recent items (last 7 days)
      const weekAgo = new Date();
      weekAgo.setDate(weekAgo.getDate() - 7);
      
      // Add recent todos
      todos.forEach(todo => {
        const createdDate = new Date(todo.createdAt);
        if (createdDate > weekAgo) {
          activities.push({
            type: 'todo',
            icon: todo.done ? '‚úÖ' : 'üìù',
            title: `${todo.done ? 'Completed' : 'Created'} todo: ${todo.title}`,
            time: createdDate,
            meta: `${Math.floor((Date.now() - createdDate) / (1000 * 60 * 60))}h ago`
          });
        }
      });
      
      // Add recent notes
      notes.forEach(note => {
        const createdDate = new Date(note.createdAt);
        if (createdDate > weekAgo) {
          activities.push({
            type: 'note',
            icon: 'üìÑ',
            title: `Created note: ${note.title}`,
            time: createdDate,
            meta: `${Math.floor((Date.now() - createdDate) / (1000 * 60 * 60))}h ago`
          });
        }
      });
      
      // Add recent projects
      projects.forEach(project => {
        const createdDate = new Date(project.createdAt);
        if (createdDate > weekAgo) {
          activities.push({
            type: 'project',
            icon: 'üìÅ',
            title: `Created project: ${project.name}`,
            time: createdDate,
            meta: `${Math.floor((Date.now() - createdDate) / (1000 * 60 * 60))}h ago`
          });
        }
      });
      
      // Sort by time
      activities.sort((a, b) => b.time - a.time);
      
      if (activities.length === 0) {
        feed.innerHTML = `
          <div class="muted center" style="padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 12px; opacity: 0.3;">‚è∞</div>
            <div>No recent activity</div>
            <div style="font-size: 12px; margin-top: 8px;">Your activity will appear here</div>
          </div>
        `;
        return;
      }
      
      feed.innerHTML = activities.slice(0, 8).map(activity => `
        <div class="activity-item">
          <div class="activity-icon">${activity.icon}</div>
          <div class="activity-content">
            <div class="activity-title">${escapeHtml(activity.title)}</div>
            <div class="activity-meta">${activity.meta}</div>
          </div>
        </div>
      `).join('');
    }
    
    async function showWelcomeBanner() {
      const banner = document.createElement('div');
      banner.id = 'welcome-banner';
      banner.style.cssText = `
        grid-column: 1 / -1;
        background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
        color: white;
        padding: 32px;
        border-radius: 16px;
        margin-bottom: 24px;
        box-shadow: var(--shadow-lg);
        animation: slideIn 0.5s ease-out;
      `;
      
      banner.innerHTML = `
        <h2 style="margin: 0 0 16px 0; font-size: 28px;">üëã Welcome to Research Notebook!</h2>
        <p style="margin: 0 0 24px 0; font-size: 16px; opacity: 0.95;">
          Get started with a demo project that shows you around. It includes sample todos and helpful notes.
        </p>
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
          <button class="btn" onclick="createDemoProject()" style="background: white; color: var(--accent); font-weight: 600;">
            üöÄ Create Demo Project
          </button>
          <button class="btn" onclick="dismissWelcome()" style="background: rgba(255,255,255,0.2); color: white;">
            Maybe Later
          </button>
        </div>
      `;
      
      const grid = document.getElementById('dashboard-grid');
      grid.insertBefore(banner, grid.firstChild);
    }
    
    window.createDemoProject = async function() {
      const banner = document.getElementById('welcome-banner');
      if (banner) {
        banner.innerHTML = '<div style="text-align: center; padding: 20px;"><div class="spinner" style="margin: 0 auto 12px;"></div><p>Creating your demo project...</p></div>';
      }
      
      try {
        await api.request('/api/demo-data', { method: 'POST' });
        showToast('Demo project created! Check your projects page.', 'success', 3000);
        
        // Refresh the page after a short delay
        setTimeout(() => window.location.reload(), 1500);
      } catch (err) {
        console.error('Failed to create demo:', err);
        showToast(err.userMessage || 'Failed to create demo project', 'error', 3000);
        if (banner) {
          banner.remove();
        }
      }
    };
    
    window.dismissWelcome = function() {
      const banner = document.getElementById('welcome-banner');
      if (banner) {
        banner.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => banner.remove(), 300);
      }
      localStorage.setItem('welcomeDismissed', 'true');
    };
    
    document.addEventListener('DOMContentLoaded', () => {
      renderAuthActions();
      loadDashboard();
    });
  </script>
</body>
</html>
