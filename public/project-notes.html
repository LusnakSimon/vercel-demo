<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Project Notes - Research Notebook</title>
  <script>
    // Apply theme immediately to prevent flash
    (function() {
      const theme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <link rel="stylesheet" href="/styles.css">
  <script src="/enhancements.js" defer></script>
</head>
<body>
  <div class="container">
    <header class="site-header">
      <div class="brand">
        <div class="logo">RN</div>
        <div>
          <h1 id="project-title">Project Notes</h1>
          <p class="lead" id="project-meta">Loading project...</p>
        </div>
      </div>
      <nav class="nav">
        <a href="/dashboard.html">Dashboard</a>
        <a href="/projects.html">Projects</a>
        <a href="/todos.html">Todos</a>
        <a href="/notes.html">Notes</a>
        <a href="/contacts.html">Contacts</a>
        <a href="/messages.html">Messages</a>
        <button id="theme-toggle" title="Toggle theme">üåô</button>
        <button id="help-toggle" title="Keyboard shortcuts (or press ?)">‚ùì</button>
        <span id="auth-actions"></span>
      </nav>
    </header>
    
    <div class="card">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:20px;flex-wrap:wrap;">
        <h2 style="margin:0;">Notes</h2>
        <button id="create-note" class="btn btn-primary">+ Create Note</button>
      </div>
      <div style="display:flex;gap:12px;margin-bottom:20px;flex-wrap:wrap;">
        <input id="search-q" type="text" placeholder="Search notes..." style="flex:1;min-width:200px;" />
        <button id="search-btn" class="btn btn-secondary">Search</button>
      </div>
      <ul id="notes-list" class="list"></ul>
    </div>
  </div>
  <script src="/app.js"></script>
  <script>
    // extract projectId from querystring
    function qs(name){ const u=new URL(location.href); return u.searchParams.get(name); }
    const projectId = qs('projectId');
    async function init(){
      if (!projectId) {
        document.getElementById('project-title').textContent = 'Project Notes (no project selected)';
      } else {
        document.getElementById('project-title').textContent = 'Project Notes';
      }
      document.getElementById('create-note').addEventListener('click', ()=>{ location.href = '/note.html?projectId=' + encodeURIComponent(projectId || '') });
      document.getElementById('search-btn').addEventListener('click', ()=> load());
      document.getElementById('search-q').addEventListener('keyup', e=>{ if(e.key==='Enter') load(); });
      renderAuthActions();
      // fetch project info for header
      if (projectId) {
        try{
          const p = await api.request('/api/projects?id=' + encodeURIComponent(projectId));
          document.getElementById('project-title').textContent = p.name || 'Project Notes';
          const meta = document.getElementById('project-meta');
          const members = (p.memberIds||[]).slice(0,5).map(id=>id).join(', ');
          meta.textContent = 'Owner: ' + (p.ownerId || '‚Äî') + (members?(' ¬∑ Members: '+members):'');
        }catch(e){ /* ignore */ }
      }
      await load();
    }
    async function load(){
      const q = document.getElementById('search-q').value;
      try{
        const url = '/api/notes?projectId=' + encodeURIComponent(projectId || '') + '&q=' + encodeURIComponent(q || '') + '&limit=100';
        const list = await api.request(url);
        const el = document.getElementById('notes-list'); el.innerHTML = '';
        if (!list.length) { el.innerHTML = '<li class="muted">No notes found</li>'; return; }
        list.forEach(n=>{
          const li = document.createElement('li'); li.className='list-item';
          const tags = n.tags ? escapeHtml(n.tags.join(', ')) : '';
          const preview = `<div style="flex:1"><strong>${escapeHtml(n.title)}</strong><div class="small muted">${tags}</div></div>`;
          const actions = document.createElement('div');
          const open = document.createElement('a'); open.href = '/note.html?id='+encodeURIComponent(n._id); open.className='btn'; open.textContent='Open';
          const del = document.createElement('button'); del.className='btn secondary'; del.style.marginLeft='8px'; del.textContent='Delete';
          del.addEventListener('click', async ()=>{
            if (!confirm('Delete this note? This cannot be undone.')) return;
            try{ await api.request('/api/notes?id='+encodeURIComponent(n._id), { method: 'DELETE' }); showToast('Deleted', 'success'); load(); }catch(e){ showToast('Delete failed: '+(e.error||JSON.stringify(e)),'error',3000); }
          });
          actions.appendChild(open); actions.appendChild(del);
          li.innerHTML = preview;
          li.appendChild(actions);
          el.appendChild(li);
        });
      }catch(err){
        const el = document.getElementById('notes-list'); el.innerHTML = '<li class="muted">Unable to load notes. Are you logged in and a project member?</li>';
      }
    }
    init();
  </script>
</body>
</html>
