<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Project Notes</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <header class="site-header">
    <a href="/">Research Notebook</a>
    <nav id="auth-actions" style="float:right"></nav>
  </header>
  <main class="container">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px">
      <div>
        <h1 id="project-title">Project Notes</h1>
        <div id="project-meta" class="muted small">Loading project...</div>
      </div>
      <div>
        <button id="create-note" class="btn">Create Note</button>
      </div>
    </div>
    <div class="row" style="margin-bottom:12px">
      <input id="search-q" placeholder="Search notes" style="margin-left:8px;flex:1" />
      <button id="search-btn" class="btn secondary" style="margin-left:6px">Search</button>
    </div>
    <ul id="notes-list" class="list"></ul>
  </main>
  <script src="/app.js"></script>
  <script>
    // extract projectId from querystring
    function qs(name){ const u=new URL(location.href); return u.searchParams.get(name); }
    const projectId = qs('projectId');
    async function init(){
      if (!projectId) {
        document.getElementById('project-title').textContent = 'Project Notes (no project selected)';
      } else {
        document.getElementById('project-title').textContent = 'Project Notes';
      }
      document.getElementById('create-note').addEventListener('click', ()=>{ location.href = '/note.html?projectId=' + encodeURIComponent(projectId || '') });
      document.getElementById('search-btn').addEventListener('click', ()=> load());
      document.getElementById('search-q').addEventListener('keyup', e=>{ if(e.key==='Enter') load(); });
      renderAuthActions();
      // fetch project info for header
      if (projectId) {
        try{
          const p = await api.request('/api/projects?id=' + encodeURIComponent(projectId));
          document.getElementById('project-title').textContent = p.name || 'Project Notes';
          const meta = document.getElementById('project-meta');
          const members = (p.memberIds||[]).slice(0,5).map(id=>id).join(', ');
          meta.textContent = 'Owner: ' + (p.ownerId || '—') + (members?(' · Members: '+members):'');
        }catch(e){ /* ignore */ }
      }
      await load();
    }
    async function load(){
      const q = document.getElementById('search-q').value;
      try{
        const url = '/api/notes?projectId=' + encodeURIComponent(projectId || '') + '&q=' + encodeURIComponent(q || '') + '&limit=100';
        const list = await api.request(url);
        const el = document.getElementById('notes-list'); el.innerHTML = '';
        if (!list.length) { el.innerHTML = '<li class="muted">No notes found</li>'; return; }
        list.forEach(n=>{
          const li = document.createElement('li'); li.className='list-item';
          const tags = n.tags ? escapeHtml(n.tags.join(', ')) : '';
          const preview = `<div style="flex:1"><strong>${escapeHtml(n.title)}</strong><div class="small muted">${tags}</div></div>`;
          const actions = document.createElement('div');
          const open = document.createElement('a'); open.href = '/note.html?id='+encodeURIComponent(n._id); open.className='btn'; open.textContent='Open';
          const del = document.createElement('button'); del.className='btn secondary'; del.style.marginLeft='8px'; del.textContent='Delete';
          del.addEventListener('click', async ()=>{
            if (!confirm('Delete this note? This cannot be undone.')) return;
            try{ await api.request('/api/notes?id='+encodeURIComponent(n._id), { method: 'DELETE' }); showToast('Deleted', 'success'); load(); }catch(e){ showToast('Delete failed: '+(e.error||JSON.stringify(e)),'error',3000); }
          });
          actions.appendChild(open); actions.appendChild(del);
          li.innerHTML = preview;
          li.appendChild(actions);
          el.appendChild(li);
        });
      }catch(err){
        const el = document.getElementById('notes-list'); el.innerHTML = '<li class="muted">Unable to load notes. Are you logged in and a project member?</li>';
      }
    }
    init();
  </script>
</body>
</html>
