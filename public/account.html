<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Account - Research Notebook</title>
  <script>
    // Apply theme immediately to prevent flash
    (function() {
      const theme = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', theme);
    })();
  </script>
  <link rel="stylesheet" href="/styles.css">
  <script src="/enhancements.js" defer></script>
</head>
<body>
  <div class="container">
    <header class="site-header">
      <div class="brand">
        <div class="logo">RN</div>
        <div>
          <h1>Account Settings</h1>
          <p class="lead">Manage your profile and preferences</p>
        </div>
      </div>
      <nav class="nav">
        <a href="/dashboard.html">Dashboard</a>
        <a href="/projects.html">Projects</a>
        <a href="/todos.html">Todos</a>
        <a href="/notes.html">Notes</a>
        <a href="/contacts.html">Contacts</a>
        <a href="/messages.html">Messages</a>
        <button id="theme-toggle" title="Toggle theme">üåô</button>
        <button id="help-toggle" title="Keyboard shortcuts (or press ?)">‚ùì</button>
        <span id="auth-actions"></span>
      </nav>
    </header>

    <div class="grid">
      <div class="card">
        <h2>Profile Information</h2>
        <div id="profile-info" class="stack" style="margin-top: 20px;">
          <p class="muted">Loading profile...</p>
        </div>
        
        <div id="edit-profile" style="display: none; margin-top: 24px;">
          <h3>Edit Profile</h3>
          <form id="update-profile-form" class="stack" style="margin-top: 16px;">
            <div>
              <label for="update-name">Name</label>
              <input id="update-name" type="text" placeholder="Your name" />
            </div>
            <div>
              <label for="update-email">Email</label>
              <input id="update-email" type="email" placeholder="your@email.com" />
            </div>
            <div class="row" style="gap: 12px;">
              <button type="submit" class="btn btn-primary">Save Changes</button>
              <button type="button" class="btn btn-secondary" onclick="cancelEdit()">Cancel</button>
            </div>
          </form>
        </div>
        
        <button id="edit-btn" class="btn btn-secondary" style="margin-top: 20px; display: none;" onclick="showEditForm()">
          Edit Profile
        </button>
      </div>

      <div class="card">
        <h3>Change Password</h3>
        <form id="change-password-form" class="stack" style="margin-top: 20px;">
          <div>
            <label for="current-password">Current Password</label>
            <input id="current-password" type="password" required />
          </div>
          <div>
            <label for="new-password">New Password</label>
            <input id="new-password" type="password" required />
          </div>
          <div>
            <label for="confirm-password">Confirm New Password</label>
            <input id="confirm-password" type="password" required />
          </div>
          <button type="submit" class="btn btn-primary">Update Password</button>
        </form>
        
        <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border);">
          <h3>Account Stats</h3>
          <div class="stack" style="margin-top: 16px;">
            <div class="list-item">
              <span class="muted">Member since</span>
              <span id="member-since">‚Äî</span>
            </div>
            <div class="list-item">
              <span class="muted">Role</span>
              <span id="user-role">‚Äî</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script src="/app.js"></script>
  <script>
    let currentUser = null;
    
    async function loadProfile() {
      try {
        const res = await api.request('/api/auth/me');
        if (res && res.user) {
          currentUser = res.user;
          document.getElementById('profile-info').innerHTML = `
            <div class="list-item">
              <span class="muted">Name</span>
              <span><strong>${escapeHtml(currentUser.name || 'Not set')}</strong></span>
            </div>
            <div class="list-item">
              <span class="muted">Email</span>
              <span>${escapeHtml(currentUser.email)}</span>
            </div>
          `;
          document.getElementById('member-since').textContent = new Date(currentUser.createdAt).toLocaleDateString();
          document.getElementById('user-role').innerHTML = `<span class="pill success">${escapeHtml(currentUser.role || 'user')}</span>`;
          document.getElementById('edit-btn').style.display = 'block';
        }
      } catch (err) {
        document.getElementById('profile-info').innerHTML = `
          <p class="muted">Please <a href="/login.html" style="color: var(--accent);">sign in</a> to view your profile.</p>
        `;
      }
    }
    
    function showEditForm() {
      document.getElementById('profile-info').style.display = 'none';
      document.getElementById('edit-btn').style.display = 'none';
      document.getElementById('edit-profile').style.display = 'block';
      document.getElementById('update-name').value = currentUser.name || '';
      document.getElementById('update-email').value = currentUser.email || '';
    }
    
    function cancelEdit() {
      document.getElementById('profile-info').style.display = 'block';
      document.getElementById('edit-btn').style.display = 'block';
      document.getElementById('edit-profile').style.display = 'none';
    }
    
    window.showEditForm = showEditForm;
    window.cancelEdit = cancelEdit;
    
    document.getElementById('update-profile-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('update-name').value.trim();
      const email = document.getElementById('update-email').value.trim();
      
      if (!email) {
        showToast('Email is required', 'error');
        return;
      }
      
      try {
        await api.request('/api/auth/update-profile', {
          method: 'POST',
          body: { name, email }
        });
        showToast('Profile updated successfully!', 'success');
        cancelEdit();
        await loadProfile();
      } catch (err) {
        showToast('Failed to update profile: ' + (err.error || 'Unknown error'), 'error');
      }
    });
    
    document.getElementById('change-password-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const current = document.getElementById('current-password').value;
      const newPass = document.getElementById('new-password').value;
      const confirm = document.getElementById('confirm-password').value;
      
      if (newPass !== confirm) {
        showToast('Passwords do not match', 'error');
        return;
      }
      
      if (newPass.length < 6) {
        showToast('Password must be at least 6 characters', 'error');
        return;
      }
      
      try {
        await api.request('/api/auth/change-password', {
          method: 'POST',
          body: { currentPassword: current, newPassword: newPass }
        });
        showToast('Password changed successfully!', 'success');
        document.getElementById('change-password-form').reset();
      } catch (err) {
        showToast('Failed to change password: ' + (err.error || 'Unknown error'), 'error');
      }
    });
    
    document.addEventListener('DOMContentLoaded', () => {
      renderAuthActions();
      loadProfile();
    });
  </script>
  
  <footer class="footer">
    <p>Research Notebook - Organize your research effectively</p>
    <div style="margin-top: 8px;">
      <a href="https://ko-fi.com/dongfeng400" target="_blank" rel="noopener" class="donate-link" title="Support this project">
        ‚òï Buy me a coffee
      </a>
    </div>
  </footer>
</body>
</html>
