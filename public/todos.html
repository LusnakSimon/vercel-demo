<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Todos - Research Notebook</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <header class="site-header">
      <div class="brand">
        <div class="logo">RN</div>
        <div>
          <h1>Todos</h1>
          <p class="lead">Manage your tasks and todos</p>
        </div>
      </div>
      <nav class="nav">
        <a href="/">Home</a>
        <a href="/dashboard.html">Dashboard</a>
        <a href="/note.html">Notes</a>
        <button id="theme-toggle" title="Toggle theme" onclick="toggleTheme()">üåô</button>
        <span id="auth-actions"></span>
      </nav>
    </header>

    <div class="grid">
      <div class="card">
        <h2>Your Todos</h2>
        
        <div class="search-filter-wrapper">
          <input 
            type="text" 
            id="search-todos" 
            placeholder="üîç Search todos..." 
          />
          <div class="filter-buttons">
            <button id="filter-all" class="btn btn-sm btn-secondary">All</button>
            <button id="filter-active" class="btn btn-sm btn-secondary">Active</button>
            <button id="filter-done" class="btn btn-sm btn-secondary">Done</button>
          </div>
        </div>
        
        <ul id="todos-list" class="todo-list"></ul>
      </div>

      <div class="card">
        <h3>Create New Todo</h3>
        <form id="create-form" class="stack">
          <div>
            <label for="title">Title</label>
            <input id="title" type="text" placeholder="Enter todo title..." required />
          </div>
          <div>
            <label for="description">Description</label>
            <textarea id="description" placeholder="Add details..." rows="4"></textarea>
          </div>
          <button class="btn btn-primary" type="submit">Create Todo</button>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal for editing todos -->
  <div id="modal-overlay" class="modal-overlay hidden">
    <div class="modal">
      <h3>Edit Todo</h3>
      <form id="modal-form" class="modal-form">
        <div>
          <label for="modal-title-input">Title</label>
          <input id="modal-title-input" type="text" required />
        </div>
        <div>
          <label for="modal-description">Description</label>
          <textarea id="modal-description" rows="4"></textarea>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn btn-secondary" id="modal-cancel">Cancel</button>
          <button type="submit" class="btn btn-primary" id="modal-save">Save Changes</button>
        </div>
      </form>
    </div>
  </div>

  <script src="/app.js"></script>
  <script>
    let allTodos = [];
    let currentFilter = 'all';
    let searchQuery = '';
    
    async function createHandler(e){
      e.preventDefault();
      const titleEl = document.getElementById('title');
      const descEl = document.getElementById('description');
      const title = titleEl.value.trim();
      const description = descEl.value.trim();
      if (!title) { showToast('Title required', 'error', 1800); return; }
      try{
        const btn = document.getElementById('create-form').querySelector('button[type=submit]');
        btn.disabled = true;
        await api.request('/api/todos',{method:'POST', body:{title,description}});
        titleEl.value = '';
        descEl.value = '';
        showToast('Todo created!', 'success', 1200);
        await loadTodos();
        btn.disabled = false;
      }catch(err){
        console.warn('create todo failed', err);
        showToast('Create failed: ' + (err && (err.error || JSON.stringify(err))), 'error', 3000);
        document.getElementById('create-form').querySelector('button[type=submit]').disabled = false;
      }
    }
    
    function filterTodos() {
      let filtered = allTodos;
      
      // Apply status filter
      if (currentFilter === 'active') {
        filtered = filtered.filter(t => !t.done);
      } else if (currentFilter === 'done') {
        filtered = filtered.filter(t => t.done);
      }
      
      // Apply search
      if (searchQuery) {
        const q = searchQuery.toLowerCase();
        filtered = filtered.filter(t => 
          t.title.toLowerCase().includes(q) || 
          (t.description && t.description.toLowerCase().includes(q))
        );
      }
      
      renderTodos(filtered);
    }
    
    function renderTodos(todos) {
      const list = document.getElementById('todos-list');
      list.innerHTML = '';
      
      if (todos.length === 0) {
        const msg = searchQuery ? 'No todos match your search' : 
                    currentFilter === 'active' ? 'No active todos' :
                    currentFilter === 'done' ? 'No completed todos' :
                    'No todos yet';
        list.innerHTML = `
          <li class="muted center" style="padding: 40px;">
            <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">üìù</div>
            <div style="font-size: 16px;">${msg}</div>
          </li>
        `;
        return;
      }
      
      // Use the global loadTodosList to render, but pass filtered todos
      todos.forEach(t => {
        const li = document.createElement('li');
        li.className = 'todo-item' + (t.done ? ' done' : '');
        const desc = t.description ? `<div class="todo-description">${escapeHtml(t.description)}</div>` : '';
        
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = t.done;
        checkbox.className = 'todo-checkbox';
        checkbox.dataset.id = t._id;
        checkbox.addEventListener('change', async (e) => {
          try {
            await api.request('/api/todos?id=' + encodeURIComponent(t._id), {
              method: 'PATCH',
              body: { done: e.target.checked }
            });
            await loadTodos();
          } catch(err) {
            showToast('Failed to update', 'error');
            e.target.checked = !e.target.checked;
          }
        });
        
        li.innerHTML = `<div class="todo-content"><div class="todo-title">${escapeHtml(t.title)}</div>${desc}</div>`;
        li.insertBefore(checkbox, li.firstChild);
        
        const actions = document.createElement('div');
        actions.className = 'todo-actions';
        const editBtn = document.createElement('button');
        editBtn.className = 'btn btn-sm btn-secondary';
        editBtn.textContent = 'Edit';
        editBtn.dataset.id = t._id;
        const delBtn = document.createElement('button');
        delBtn.className = 'btn btn-sm btn-danger';
        delBtn.textContent = 'Delete';
        delBtn.dataset.id = t._id;
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);
        li.appendChild(actions);
        list.appendChild(li);
      });
    }
    
    async function loadTodos(){
      const list = document.getElementById('todos-list');
      if (list) list.innerHTML = '<li class="muted center" style="padding: 40px;"><div class="spinner" style="margin: 0 auto 12px;"></div>Loading...</li>';
      try {
        allTodos = await api.request('/api/todos');
        filterTodos();
      } catch(err) {
        list.innerHTML = '<li class="muted center" style="padding: 40px;">Please sign in to view your todos.</li>';
      }
    }
    
    document.getElementById('create-form').addEventListener('submit', createHandler);
    
    // Search input
    document.getElementById('search-todos').addEventListener('input', (e) => {
      searchQuery = e.target.value.trim();
      filterTodos();
    });
    
    // Filter buttons
    document.getElementById('filter-all').addEventListener('click', () => {
      currentFilter = 'all';
      document.querySelectorAll('[id^="filter-"]').forEach(btn => btn.classList.remove('btn-primary'));
      document.getElementById('filter-all').classList.add('btn-primary');
      filterTodos();
    });
    
    document.getElementById('filter-active').addEventListener('click', () => {
      currentFilter = 'active';
      document.querySelectorAll('[id^="filter-"]').forEach(btn => btn.classList.remove('btn-primary'));
      document.getElementById('filter-active').classList.add('btn-primary');
      filterTodos();
    });
    
    document.getElementById('filter-done').addEventListener('click', () => {
      currentFilter = 'done';
      document.querySelectorAll('[id^="filter-"]').forEach(btn => btn.classList.remove('btn-primary'));
      document.getElementById('filter-done').classList.add('btn-primary');
      filterTodos();
    });
    
    // Set initial active filter button
    document.getElementById('filter-all').classList.add('btn-primary');
  </script>
</body>
</html>
